[TOC]

# 安装前准备
注意： Arch Linux 安装镜像不支持安全启动（Secure Boot）。要引导安装媒介，需要 禁用安全启动。如果需要，可在完成安装后重新配置 安全启动。

## 下载
[arch](https://archlinux.org/download/)

## 烧盘
rufus dd模式

## 控制台字体
控制台字体位于 /usr/share/kbd/consolefonts/ 目录中
```
> setfont LatGrkCyr-12x22.psfu.gz
```

## 连接到因特网
确保系统已经启用了 网络接口，用 ip-link 检查:
```
> ip link
```

## 更新系统时间
```
> timedatectl set-ntp true
```

## 建立磁盘分区
### 查看磁盘
磁盘若被系统识别到，就会被分配为一个块设备，如 /dev/sda, /dev/nvme0n1 或 /dev/mmcblk0。
可以使用 `lsblk` 或者 `fdisk` 查看：
#### lsblk
```
> lsblk
NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
nvme0n1     259:0    0 931.5G  0 disk
├─nvme0n1p1 259:1    0   512M  0 part /boot
└─nvme0n1p2 259:2    0   931G  0 part /
nvme2n1     259:3    0 476.9G  0 disk
├─nvme2n1p1 259:4    0   529M  0 part
├─nvme2n1p2 259:5    0   100M  0 part
├─nvme2n1p3 259:6    0    16M  0 part
└─nvme2n1p4 259:7    0 476.3G  0 part
nvme1n1     259:8    0   1.1T  0 disk
└─nvme1n1p1 259:9    0   1.1T  0 part
```
#### fdisk
```
> fdisk -l
Disk /dev/nvme0n1：931.51 GiB，1000204886016 字节，1953525168 个扇区
磁盘型号：Samsung SSD 970 EVO Plus 1TB
单元：扇区 / 1 * 512 = 512 字节
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节
磁盘标签类型：gpt
磁盘标识符：D4517714-4358-254D-9CC2-8345A87B77CC

设备              起点       末尾       扇区  大小 类型
/dev/nvme0n1p1    2048    1050623    1048576  512M Linux 文件系统
/dev/nvme0n1p2 1050624 1953525134 1952474511  931G Linux 文件系统
```

### 分区
BIOS与MBR
| 挂载点 | 分区                                | 分区类型              | 建议大小     |
| ------ | ----------------------------------- | --------------------- | ------------ |
| [SWAP] | /dev/swap_partition（交换空间分区） | Linux swap (交换空间) | 大于 512 MiB |
| /mnt   | /dev/root_partition（根分区）       | Linux                 | 剩余空间     |

UEFI与GPT
| 挂载点                | 分区                                      | 分区类型                | 建议大小     |
| --------------------- | ----------------------------------------- | ----------------------- | ------------ |
| /mnt/boot 或 /mnt/efi | /dev/efi_system_partition（efi 系统分区） | EFI 系统分区            | 至少 260 MiB |
| [SWAP]                | /dev/swap_partition（交换空间分区）       | Linux swap (交换空间)   | 大于 512 MiB |
| /mnt                  | /dev/root_partition（根分区）             | Linux x86-64 根目录 (/) | 剩余空间     |

#### cfdisk
```
> cfdisk /dev/nvme0n1

# EFI分区格式要求FAT32
> mkfs.fat -F 32 /dev/nvme0n1p1

# 设置主分区格式EXT4
> mkfs.ext4 /dev/nvme0n1p2
```
#### gdisk
null
#### 格式化
```
# EFI分区格式要求FAT32
> mkfs.fat -F 32 /dev/nvme0n1p1
# 设置主分区格式EXT4
> mkfs.ext4 /dev/nvme0n1p2
```
## 挂载分区
将根磁盘卷 挂载到 `/mnt`，例如：
```
> mount /dev/nvme0n1p2 /mnt
> mkdir /mnt/boot
> mount /dev/nvme0n1p1 /mnt/boot
```

# 安装
## 选择镜像
文件 `/etc/pacman.d/mirrorlist` 定义了软件包会从哪个镜像源下载。在连接到因特网后，`reflector` 会通过选择20个最新同步的 HTTPS 镜像并按下载速率对其进行排序来更新镜像列表。

在列表中越前的镜像在下载软件包时有越高的优先权。您或许想检查一下文件，看看是否满意。如果不满意，可以相应的修改 /etc/pacman.d/mirrorlist 文件，并将地理位置最近的镜像源挪到文件的头部，同时也应该考虑一些其他标准。

这个文件接下来还会被 pacstrap 拷贝到新系统里，所以请确保设置正确。
[reflector]

## 安装必须的软件包
使用 pacstrap 脚本，安装 `base` 软件包和 `Linux` 内核以及常规硬件的固件：
```
> pacstrap /mnt base linux linux-firmware
```
提示：
可以将 linux 替换为 kernel 页面中介绍的内核软件包。
在虚拟机或容器中安装时，可以不安装固件软件包。

常用包清单
+ base
+ dhcpcd 联网
+ iwd 无线网
+ base-devel 

# 配置系统
## fstab
用以下命令生成 fstab 文件 (用 -U 或 -L 选项设置UUID 或卷标)：
```
> genfstab -U /mnt >> /mnt/etc/fstab
```
强烈建议在执行完以上命令后，后检查一下生成的 `/mnt/etc/fstab` 文件是否正确。

## chroot
change root 到新安装的系统：
```
> arch-chroot /mnt
```

## 时区
```
> ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
# 这个命令假定硬件时间已经被设置为 UTC 时间。详细信息请查看 System time#Time standard。
> hwclock --systohc
```

## 本地化
本地化的程序与库若要本地化文本，都依赖 Locale，后者明确规定地域、货币、时区日期的格式、字符排列方式和其他本地化标准。

需在这两个文件设置：
+ locale.gen 
+ locale.conf

```
# 编辑然后移除需要的 `地区` 前的注释符号 `#`
> sudo vim /etc/locale.gen
# 这里提供了不少语言与对应编码，取消注释以下编码：
# en_US.UTF-8 UTF-8
# zh_CN.UTF-8 UTF-8
# 接着执行 `locale-gen` 以生成 `locale` 信息
> sudo locale-gen
> su -i
> echo LANG=zh_CN.utf8 > /etc/locale.conf
```
警告： 不推荐在此设置任何中文 locale，会导致 tty 乱码。

## 主机名
```
> vim /etc/hostname
```
添加对应的信息到 `hosts`
```
/etc/hosts
127.0.0.1	localhost
::1		localhost
127.0.1.1	myhostname.localdomain	myhostname # 主机名.本地域名 主机名
```
如果系统有一个永久的 IP 地址，请使用这个永久的 IP 地址而不是 127.0.1.1。请注意，目前的 base 不含有任何网络管理工具。针对新安装的系统环境，请完成网络配置，配置过程中可能包括要安装合适的网络管理软件。

## 用户
### root密码
理论上有了sudo，我们就不必再用root账号了。但这并不表示绝对安全，因为TTY模式下还能输入root账号名来登录root账号，而且默认是没有密码的！
更重要的是，访客也可以通过ssh等来直接登录！
```
> sudo -i
> passwd
```

### 授予sudo权限
使用visudo工具来编辑sudo的配置文件，所有能使用sudo来执行命令的用户，都应当是“wheel”这个用户组的成员。因此，我们要在wheel组的用户使用sudo
```
> visudo
// 取消[%whell All = (All) All]的注释
```
在Linux中wheel组就类似于一个管理员的组。
通常在LUNIX下，即使我们有系统管理员root的权限，也不推荐用root用户登录。一般情况下用普通用户登录就可以了，在需要root权限执行一些操作时，再su登录成为root用户。但是，任何人只要知道了root的密码，就都可以通过su命令来登录为root用户--这无疑为系统带来了安全隐患。所以，将普通用户加入到wheel组，被加入的这个普通用户就成了管理员组内的用户，但如果不对一些相关的配置文件进行配置，这个管理员组内的用户与普通用户也没什么区别--就像警察下班后，没有带枪、穿这便衣和普通人（用户）一样，虽然他的的确确是警察。

### 创建用户
创建一个新用户，以后登录就用它，配合sudo，取代默认的root用户，提高安全性。
使用useradd来创建用户：
useradd -G wheel -m 用户名，其中-m参数代表自动创建用户的家目标。
passwd 用户名
```
> useradd -G wheel -m [username]
> passwd [username]
> ls /home
```

## 处理器微码
```
> pacman -S intel-ucode/amd-ucode
```

## 引导
### refind
### grub(GRand Unified Bootloader)
### bootctl(systemd-boot)

## 退出
输入 `exit` 或按 `Ctrl+d` 退出 `chroot` 环境
可选用 `umount -R /mnt` 手动卸载被挂载的分区：这有助于发现任何「繁忙」的分区，并通过 `fuser` 查找原因。
最后，通过执行 `reboot` 重启系统，`systemd` 将自动卸载仍然挂载的任何分区。不要忘记移除安装介质，然后使用 `root` 帐户登录到新系统。