[TOC]

# 下载
<https://archlinux.org/download/>

# 烧盘
rufus dd模式

# 磁盘分区
```
// 查看磁盘
> fdisk -l

// 分区，设置BOOT与HOME
> cfdisk /dev/nvme0n1

// EFI分区格式要求FAT32
> mkfs.fat -F 32 /dev/nvme0n1p1

// 设置主分区格式EXT4
> mkfs.ext4 /dev/nvme0n1p2
```

# 挂载至安装U盘
U盘是一个系统，将目标磁盘挂载并在其上安装系统，挂载目标是/mnt，它会作为我们系统安装的目标目录
```
> mount /dev/nvme0n1p2 /mnt
> mkdir /mnt/boot
> mount /dev/nvme0n1p1 /mnt/boot
```

# 安装系统核心组件
pacstrap是pacman的一个前端
+ base：基础组件
+ linux：Linux内核
+ linux-firmware：系统固件，包含一些驱动程序
+ base-devel：开发控件
```
> pacstrap /mnt base linux linux-firmware base-devel
```

# 生成fstab
fstab是自动挂载文件系统不可或缺的文件，缺少则无法启动。
这个工具只在安装环境中提供
首先exit，退出chroot环境
然后在咱环境里运行：
```
> genfstab /mnt > /mnt/etc/fstab
```
最后可检验一下目标系统中生成得到的fstab

# 切换到目标系统
有的操作只能在chroot中进行，有的只能在外面进行
```
> arch-chroot /mnt
```

# 安装启动器
```
> pacman -S grub efibootmgr intel-ucode(amd-ucode) os-prober
> mkdir /boot/grub
> grub-mkconfig > /boot/grub/grub.cfg
> grub-install --target=x86_64-efi --efi-directory=/boot
```

# 用户
## 安装sudo
arch要自己安装
```
> pacman -S sudo neovim
> ln -s nvim /usr/bin/vim
> ln -s nvim /usr/bin/vi
```

## 设置root密码
理论上有了sudo，我们就不必再用root账号了。但这并不表示绝对安全，因为TTY模式下还能输入root账号名来登录root账号，而且默认是没有密码的！
更重要的是，访客也可以通过ssh等来直接登录！
```
> sudo -i
> passwd
```

## 授予sudo权限
使用visudo工具来编辑sudo的配置文件，所有能使用sudo来执行命令的用户，都应当是“wheel”这个用户组的成员。因此，我们要在wheel组的用户使用sudo
```
> visudo
// 取消[%whell All = (All) All]的注释
```

## 创建用户
创建一个新用户，以后登录就用它，配合sudo，取代默认的root用户，提高安全性。
使用useradd来创建用户：
useradd -G wheel -m 用户名，其中-m参数代表自动创建用户的家目标。
passwd 用户名
```
> useradd -G wheel -m [username]
> passwd [username]
> ls /home
```

# 本地化
## 安装中文字体
ArchLinux默认没有中文字体，无法显示中文，必须手动安装
```
$ pacman -S noto-fonts-cjk noto-fonts noto-fonts-emoji wqy-microhei
```
以上选用谷歌开源字体Noto，包括中日韩字体、英文字体以及Emoji字体

## 方言
Locale数据，用于控制操作系统的本地化，以支持不同的语音、时间格式等。
首先打开Locale生成器配置：
```
$ sudo vim /etc/locale.gen
这里提供了不少语言与对应编码，取消注释以下编码：
en_US.UTF-8 UTF-8
zh_CN.UTF-8 UTF-8
zh_TW.UTF-8 UTF-8
```
中文支持的基础就是locale，但系统不会默认生成，仍需手动生成。

生成Locale
```
sudo locale-gen
```
将语言设置为中文：
```
export LANG=zh_CN.utf8
```
然后尝试运行一些带中文的命令，看看能否正常显示中文。

例如：
ls --help

设置默认Locale
一般把默认Locale设为英文，便于调试，且不容易有乱码。
先用`sudo -i`切换到root，然后运行
```
echo LANG=zh_CN.utf8 > /etc/locale.conf
```
最后用exit命令返回


# 包管理
## 编辑镜像源
```
> vim /etc/pacman.d/mirrorlist
## 推荐网易源
## China
Server = http://mirrors.163.com/archlinux/$repo/os/$arch
```
## reflector
首先安装reflector工具
```
> sudo pacman -S reflector
```
然后执行
```
> sudo reflector --sort rate --threads 100 -c China --save /etc/pacman.d/mirrorlist
```
最终生成的mirrorlist如下面的样子
```
Server = http://mirrors.163.com/archlinux/$repo/os/$arch
Server = https://mirrors.dgut.edu.cn/archlinux/$repo/os/$arch
Server = https://mirrors.nju.edu.cn/archlinux/$repo/os/$arch
Server = https://mirrors.tuna.tsinghua.edu.cn/archlinux/$repo/os/$arch
Server = https://mirrors.bfsu.edu.cn/archlinux/$repo/os/$arch
Server = http://mirrors.bfsu.edu.cn/archlinux/$repo/os/$arch
Server = http://mirrors.zju.edu.cn/archlinux/$repo/os/$arch
Server = http://mirrors.nju.edu.cn/archlinux/$repo/os/$arch
Server = http://mirrors.tuna.tsinghua.edu.cn/archlinux/$repo/os/$arch
Server = https://mirrors.sjtug.sjtu.edu.cn/archlinux/$repo/os/$arch
Server = http://mirrors.dgut.edu.cn/archlinux/$repo/os/$arch
```

## 设置ArchLinuxCN
archlinuxcn是由国人社区维护的一个Arch LInux软件源，包含了不少不被官方包含的软件、库等，尤其是国人原创的。

Archlinuxcn是由来自我国的团队维护的软件源，主要提供官方源之外的以下实用软件：


| 软件类型                                       | 举例                                                                                                                     |
| ---------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------ |
| 闭源的免费软件                                 | Google Chrome、Android Studio、WPS Office                                                                                |
| 商业软件                                       | JetBrains全家桶（Intellij Idea、PyCharm、WebStorm）                                                                      |
| 开源软件的官方构建版                           | Visual Studio Code。Arch官方源也有，但界面和功能与微软官方版有明显区别                                                   |
| 官方源未收录的实用软件                         | NVM（Node.js版本切换工具）、Oh My Zsh（火爆的zsh增强工具）、Logisim（电路仿真工具）                                      |
| 官方源也有，但影响用户体验                     | Pandoc，官方源提供的版本会捆绑Haskell的依赖，数百兆很臃肿，一般用户用不上。Archlinuxcn则提供了静态链接的版本pandoc-bin。 |
| 从GitHub编译而来的自由软件，与官方源版本不兼容 | 一般包名有-git后缀。如Fcitx。                                                                                            |

```
> sudo vim /etc/pacman.conf
[archlinuxcn]
Server = https://mirrors.ustc.edu.cn/archlinuxcn/$arch
```
更新软件仓库
```
> sudo pacman -Sy
```
要想使用archlinuxcn，还需要安装密钥环
```
> sudo pacman -S archlinuxcn-keyring
```
如果密钥报错【GnuPG-2.1 与 pacman 密钥环】
由于升级到了 gnupg-2.1，pacman 上游更新了密钥环的格式，这使得本地的主密钥无法签署其它密钥。这不会出问题，除非你想自定义 pacman 密钥环。不过，我们推荐所有用户都生成一个新的密钥环以解决潜在问题。
此外，我们建议您安装 haveged，这是一个用来生成系统熵值的守护进程，它能加快加密软件（如 gnupg，包括生成新的密钥环）关键操作的速度。
要完成这些操作，请以 root 权限运行：
```
> pacman -Syu haveged
> systemctl start haveged
> systemctl enable haveged

> rm -fr /etc/pacman.d/gnupg
> pacman-key --init
> pacman-key --populate archlinux
> pacman-key --populate archlinuxcn
```

# 配置
## 设置主机名
主机名是自己电脑的标志，在局域网中非常重要。编辑用来存放主机名的文件：
```
sudo vim /etc/hostname
```