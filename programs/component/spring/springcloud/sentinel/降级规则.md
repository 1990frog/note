[TOC]

# 概览
Sentinel熔断降级会在调用链路中某个资源出现不稳定状态时（例如调用超时或异常比例升高），对这个资源的调用进行限制，让请求快速失败，避免影响到其它的资源而导致级联错误。
当资源被降级后，在接下来的降级时间窗口之内，对该资源的调用都自动熔断（默认行为是抛出 DegradeException）
由于被调用的资源熔断了，所以可以在feign上指定降级处理机制，类似与redis内存穿透的处理方式

## 服务熔断
在股票市场，熔断这个词大家都不陌生，是指当股指波幅达到某个点后，交易所为控制风险采取的暂停交易措施。
相应的，服务熔断一般是指软件系统中，由于某些原因使得服务出现了过载现象，为防止造成整个系统故障，从而采用的一种保护措施，所以很多地方把熔断亦称为过载保护。
为了解决上述问题，服务熔断的思想被提出来。类似现实世界中的“保险丝“，当某个异常条件被触发，直接熔断整个服务，而不是一直等到此服务超时。
熔断的触发条件可以依据不同的场景有所不同，比如统计一个时间窗口内失败的调用次数。

## 服务降级
大家都见过女生旅行吧，大号的旅行箱是必备物，平常走走近处绰绰有余，但一旦出个远门，再大的箱子都白搭了，怎么办呢？
常见的情景就是把物品拿出来分分堆，比了又比，最后一些非必需品的就忍痛放下了，等到下次箱子够用了，再带上用一用。
而服务降级，就是这么回事，整体资源快不够了，忍痛将某些服务先关掉，待渡过难关，再开启回来

有了熔断，就得有降级。
所谓降级，就是当某个服务熔断之后，服务器将不再被调用，此时客户端可以自己准备一个本地的fallback回调，返回一个缺省值。
这样做，虽然服务水平下降，但好歹可用，比直接挂掉要强，当然这也要看适合的业务场景

# 常见的熔断状态
## Closed
未熔断状态
## Open
熔断器打开状态，此时对下游的调用都内部直接返回错误，不走网络，但设计了一个时钟选项，默认的时钟达到了一定时间（这个时间一般设置成平均故障处理时间，也就是MTTR），到了这个时间，进入半熔断状态；
## Half-Open（sentinel不支持）
半熔断状态，允许定量的服务请求，如果调用都成功（或一定比例）则认为恢复了，关闭熔断器，否则认为还没好，又回到熔断器打开状态；

# sentinel策略
## RT策略：1s内5个请求超时（rt时间ms）就进入时间窗口（熔断时间s）
如果未设置降级回调方法就抛出`DegradeException`异常
注意Sentinel默认统计的RT上限是`4900ms`，超出此阈值的都会算作`4900ms`，若需要变更此上限可以通过启动配置项 `-Dcsp.sentinel.statistic.max.rt=xxx`来配置。

## 异常比例策略：1s内请求量大于5次，并且异常比例满足设定值，就进入时间窗口（熔断时间s）
当资源的每秒请求量>=`5`，并且每秒异常总数占通过量的比值超过阈值（DegradeRule中的count）之后，资源进入降级状态，即在接下的时间窗口（`DegradeRule`中的`timeWindow`，以s为单位）之内，对这个方法的调用都会自动地返回。异常比率的阈值范围是 [0.0, 1.0]，代表 0% - 100%。

## 异常数策略：1分钟异常数超过设定的阈值，就进入时间窗口（熔断时间s）
当资源近`1`分钟的异常数目超过阈值之后会进行熔断。
注意由于统计时间窗口是`分钟级别`的，若`timeWindow`小于`60s`，则结束熔断状态后仍可能再进入熔断状态。

源码：`com.alibaba.csp.entinel.slots.block.degrade.DegradeRule#passCheck`


