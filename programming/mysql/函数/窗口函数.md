[TOC]

# 概览
MySQL从8.0开始支持窗口函数，这个功能在大多数据库中早已支持，有的也叫分析函数。那么什么是窗口呢？

窗口的概念非常重要，它可以理解为记录集合，窗口函数也就是在满足某种条件的记录集合上执行的特殊函数。对于每条记录都要在此窗口内执行函数，有的函数随着记录不同，窗口大小都是固定的，这种属于静态窗口；有的函数则相反，不同的记录对应着不同的窗口，这种动态变化的窗口叫滑动窗口。简单的说窗口函数就是对于查询的每一行，都使用与该行相关的行进行计算。

窗口函数和普通聚合函数很容易混淆，二者区别如下：
+ 聚合函数是将多条记录聚合为一条；而窗口函数是每条记录都会执行，有几条记录执行完还是几条。
+ 聚合函数也可以用于窗口函数中。

|       名称       |                                                       	描述                                                        |
| --------------- | -------------------------------------------------------------------------------------------------------------------- |
| CUME_DIST()	     | 计算一组值中一个值的累积分布                                                                                              |
| DENSE_RANK()     | 	根据该ORDER BY子句为分区中的每一行分配一个等级。它将相同的等级分配给具有相等值的行。如果两行或更多行具有相同的排名，则排名值序列中将没有间隙 |
| FIRST_VALUE()	 | 返回相对于窗口框架第一行的指定表达式的值                                                                                     |
| LAG()           | 	返回分区中当前行之前的第N行的值。如果不存在前一行，则返回NULL                                                                  |
| LAST_VALUE()     | 	返回相对于窗口框架中最后一行的指定表达式的值                                                                               |
| LEAD()	         | 返回分区中当前行之后的第N行的值。如果不存在后续行，则返回NULL                                                                   |
| NTH_VALUE()	     | 从窗口框架的第N行返回参数的值                                                                                              |
| NTILE()	         | 将每个窗口分区的行分配到指定数量的排名组中                                                                                   |
| PERCENT_RANK()	 | 计算分区或结果集中行的百分数等级                                                                                           |
| RANK()          | 	与DENSE_RANK()函数相似，不同之处在于当两行或更多行具有相同的等级时，等级值序列中存在间隙                                            |
| ROW_NUMBER()     | 	为分区中的每一行分配一个顺序整数                                                                                         |

将上述函数按照功能划分，可以把MySQL支持的窗口函数分为如下几类：
+ 序号函数：ROW_NUMBER()、RANK()、DENSE_RANK()
+ 分布函数：PERCENT_RANK()、CUME_DIST()
+ 前后函数：LAG()、LEAD()
+ 头尾函数：FIRST_VALUE()、LAST_VALUE()
+ 其他函数：NTH_VALUE()、NTILE()

# 语法
```sql
function_name([exp])
OVER(
    [PARTITION BY exp [, ...]]
    [ORDER BY exp [ASC|DESC] [, ...]]
)
```

先指定作为窗口函数的函数名，后面跟一个表达式，然后是OVER(…)，就算OVER里面没有内容，括号也需要保留。
窗口函数的一个概念是当前行，当前行属于某个窗口，窗口由“[partition_defintion]”，“[order_definition]”，“[frame_definition]“确定。
+ window_name：给窗口指定一个别名，如果SQL中涉及的窗口较多，采用别名可以看起来更清晰易读。
+ partition_defintion：窗口按照指定字段进行分区，两个分区由分区边界分隔，窗口功能在分区内执行，并在跨越分区边界时重新初始化。
+ order_definition：按照指定字段进行排序，窗口函数将按照排序后的记录顺序进行编号。可以和partition子句配合使用，也可以单独使用。
+ frame子句：frame是当前分区的一个子集，在分区里面再进一步细分窗口，子句用来定义子集的规则，通常用来作为滑动窗口使用。



