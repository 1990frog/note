<!-- TOC -->

- [离线安装](#%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85)
    - [下载](#%E4%B8%8B%E8%BD%BD)
    - [解压安装包](#%E8%A7%A3%E5%8E%8B%E5%AE%89%E8%A3%85%E5%8C%85)
    - [将docker 相关命令拷贝到 /usr/bin](#%E5%B0%86docker-%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4%E6%8B%B7%E8%B4%9D%E5%88%B0-usrbin)
    - [启动守护进程](#%E5%90%AF%E5%8A%A8%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B)
    - [service](#service)
- [权限](#%E6%9D%83%E9%99%90)
- [仓库镜像](#%E4%BB%93%E5%BA%93%E9%95%9C%E5%83%8F)
- [网络代理](#%E7%BD%91%E7%BB%9C%E4%BB%A3%E7%90%86)
    - [docker 代理](#docker-%E4%BB%A3%E7%90%86)
    - [container 代理](#container-%E4%BB%A3%E7%90%86)
    - [build 代理](#build-%E4%BB%A3%E7%90%86)

<!-- /TOC -->

# 离线安装
## 下载
[download](https://download.docker.com/linux/static/stable/x86_64/)

## 解压安装包
```
> tar zxf docker.tgz
```

## 将docker 相关命令拷贝到 /usr/bin
```
> cp docker/* /usr/bin/
```

## 启动守护进程
```
> dockerd &
```

## service
```
> sudo vi /usr/lib/systemd/system/docker.service

[Unit]
Description=Docker Application Container Engine
Documentation=https://docs.docker.com
After=network-online.target firewalld.service
Wants=network-online.target

[Service]
Type=notify
ExecStart=/usr/bin/dockerd
ExecReload=/bin/kill -s HUP $MAINPID
LimitNOFILE=infinity
LimitNPROC=infinity
TimeoutStartSec=0
Delegate=yes
KillMode=process
Restart=on-failure
StartLimitBurst=3
StartLimitInterval=60s

[Install]
WantedBy=multi-user.target
```

# 权限
创建docker用户组，并将用户添加到改用户组（免sudo）
```
创建docker用户组
$ sudo groupadd docker
添加用户到docker组
$ sudo gpasswd -a {user} docker
```
重启docker,shell生效

# 仓库镜像
镜像文件
`sudo nvim /etc/docker/daemon.json`
修改镜像
```json
{
    "registry-mirrors":
    [
        "http://hub-mirror.c.163.com"
    ]
}
```

# 网络代理
## docker 代理
```
> vim /etc/systemd/system/docker.service.d/proxy.conf
[Service]
Environment="HTTP_PROXY=http://proxy.example.com:8080/"
Environment="HTTPS_PROXY=http://proxy.example.com:8080/"
Environment="NO_PROXY=localhost,127.0.0.1,.example.com"

> systemctl daemon-reload
> systemctl restart docker.service
> systemctl show --property=Environment docker
```

## container 代理
在容器运行阶段，如果需要代理上网，则需要配置 ~/.docker/config.json。以下配置，只在Docker 17.07及以上版本生效。
```
{
 "proxies":
 {
   "default":
   {
     "httpProxy": "http://proxy.example.com:8080",
     "httpsProxy": "http://proxy.example.com:8080",
     "noProxy": "localhost,127.0.0.1,.example.com"
   }
 }
}
```

## build 代理
虽然 docker build 的本质，也是启动一个容器，但是环境会略有不同，用户级配置无效。在构建时，需要注入 http_proxy 等参数。
```
docker build . \
    --build-arg "HTTP_PROXY=http://proxy.example.com:8080/" \
    --build-arg "HTTPS_PROXY=http://proxy.example.com:8080/" \
    --build-arg "NO_PROXY=localhost,127.0.0.1,.example.com" \
    -t your/image:tag
```
