[TOC]

Sentinel 系统自适应限流从整体维度对应用入口流量进行控制，结合应用的 `Load`、`CPU 使用率`、`总体平均 RT`、`入口 QPS` 和`并发线程数`等几个维度的监控指标，通过自适应的流控策略，让系统的入口流量和系统的负载达到一个平衡，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。

在开始之前，我们先了解一下系统保护的目的：
+ 保证系统不被拖垮
+ 在系统稳定的前提下，保持系统的吞吐量

# 系统规则
系统保护规则是从应用级别的入口流量进行控制，从单台机器的 load、CPU 使用率、平均 RT、入口 QPS 和并发线程数等几个维度监控应用指标，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。

系统保护规则是应用整体维度的，而不是资源维度的，并且仅对入口流量生效。入口流量指的是进入应用的流量（EntryType.IN），比如 Web 服务或 Dubbo 服务端接收的请求，都属于入口流量。

系统规则支持以下的模式：
+ Load 自适应（仅对 Linux/Unix-like 机器生效）：系统的 load1 作为启发指标，进行自适应系统保护。当系统 load1 超过设定的启发值，且系统当前的并发线程数超过估算的系统容量时才会触发系统保护（BBR 阶段）。系统容量由系统的 maxQps * minRt 估算得出。设定参考值一般是 CPU cores * 2.5。
+ CPU usage（1.5.0+ 版本）：当系统 CPU 使用率超过阈值即触发系统保护（取值范围 0.0-1.0），比较灵敏。
+ 平均 RT：当单台机器上所有入口流量的平均 RT 达到阈值即触发系统保护，单位是毫秒。
+ 并发线程数：当单台机器上所有入口流量的并发线程数达到阈值即触发系统保护。
+ 入口 QPS：当单台机器上所有入口流量的 QPS 达到阈值即触发系统保护。

# 原理
![50813887-bff10300-1352-11e9-9201-437afea60a5a](https://raw.githubusercontent.com/1990frog/imagebed/default/1602319267_20200330135743290_1339176213.png)

我们把系统处理请求的过程想象为一个水管，到来的请求是往这个水管灌水，当系统处理顺畅的时候，请求不需要排队，直接从水管中穿过，这个请求的RT是最短的；反之，当请求堆积的时候，那么处理请求的时间则会变为：排队时间 + 最短处理时间。

